<!DOCTYPE html>
<html>
<head>
    <title>진료시간 안내</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @font-face {
            font-family: 'S-CoreDream';
            src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/S-CoreDream-5Medium.woff') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'GmarketSansMedium';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/GmarketSansMedium.woff2') format('woff2'),
                 url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/GmarketSansMedium.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }

        body {
            font-family: 'S-CoreDream', 'Malgun Gothic', '맑은 고딕', sans-serif;
            font-size: 3vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 0.2vh;
            box-sizing: border-box;
            background-color: #212529;
            color: #f8f9fa;
            height: 100vh;
            overflow: auto;
        }

        .title-box {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #004c6d; /* 깊고 선명한 파란색으로 변경 */
            border: 1px solid #0077a6; /* 테두리 색상도 함께 변경 */
            border-radius: 10px;
            margin-top: 0.5vh;
            margin-left: 0.5vh;
            margin-right: 0.5vh;
            margin-bottom: 1vh;
            padding: 0.2vh 1.5vh; /* 수직 여백을 줄여 로고 공간 확보 */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            width: 98%;
            box-sizing: border-box;
        }

        .title-group {
            display: flex;
            align-items: center; /* 로고와 텍스트를 수직 중앙 정렬 */
            gap: 1em;
        }

        #logo {
            height: 6vh; /* 박스에 맞춰 로고 크기 최대화 */
        }

        .main-title {
            font-family: 'GmarketSansMedium', sans-serif;
            color: #f8f9fa;
            margin: 0;
            font-size: 5vh;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .current-date {
            font-family: 'S-CoreDream', sans-serif;
            font-size: 2.5vh;
            font-weight: normal;
            color: #ced4da;
            margin: 0; /* p 태그의 기본 마진 제거 */
        }

        .schedule-container {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
            flex: 1;
            width: 98%;
            background-color: #2a3641;
            border-radius: 10px;
            padding: 0.2vh;
            box-sizing: border-box;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            overflow: auto;
        }

        .time-slot-box {
            display: flex;
            flex-direction: column;
            border: 1px solid #4a5c6d;
            border-radius: 8px;
            margin: 0.3vh;
            padding: 0.5vh;
            flex: 1 1 45%;
            min-width: 300px;
            position: relative; /* 오버레이를 위한 위치 기준 설정 */
            transition: opacity 0.5s ease, filter 0.5s ease;
        }

        .time-slot-box.am {
            background-color: #242f39;
        }

        .time-slot-box.pm {
            background-color: #242f39;
        }

        .finished-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(52, 58, 64, 0.65); /* 반투명 회색 오버레이 */
            /* 사선 패턴 추가 */
            background-image: repeating-linear-gradient(
                -45deg,
                transparent, transparent 15px,
                rgba(0, 0, 0, 0.1) 15px, rgba(0, 0, 0, 0.1) 30px
            );
            display: none; /* 기본적으로 숨김 */
            justify-content: center; /* 가로 중앙 정렬 */
            align-items: center; /* 세로 중앙 정렬 */
            border-radius: 8px;
            z-index: 3; /* 다른 모든 오버레이와 내용을 덮도록 최상위로 설정 */
        }

        .finished-overlay span {
            background-color: #495057; /* 텍스트를 감싸는 회색 박스 배경 */
            color: #f8f9fa; /* 밝은 텍스트 색상 */
            padding: 1vh 2.5vh; /* 박스 내부 여백 */
            border-radius: 10px; /* 박스 모서리 둥글게 */
            border: 2px solid #6c757d; /* 박스 테두리 */
            box-shadow: 0 2px 8px rgba(0,0,0,0.5); /* 입체감을 위한 그림자 */
            font-size: 6vh; /* 글자 크기 확대 */
            font-family: 'GmarketSansMedium', sans-serif;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(0,0,0,0.7); /* 텍스트 그림자 조정 */
        }

        .schedule-section-title {
            font-family: 'GmarketSansMedium', sans-serif;
            text-align: center;
            color: #f8f9fa;
            margin: 0 0 0.5vh 0;
            font-size: 4.5vh;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 3.7vh; /* 글자 크기 재조정 */
            border-spacing: 0;
            table-layout: fixed;
        }

        th, td {
            border: 0;
            padding: 0.2vh 0.5vh; /* 수직 여백 최소화, 수평 여백 유지 */
            text-align: center;
            white-space: normal;
        }

        th:nth-child(1), td:nth-child(1) {
            width: 46%;
        }
        
        td:nth-child(1) {
            text-align: left;
            padding-left: 0.5em; /* 진료과 왼쪽 여백 추가 축소 */
        }

        th:nth-child(2), td:nth-child(2) {
            width: 27%;
        }
        th:nth-child(3), td:nth-child(3) {
            width: 27%;
        }

        th {
            font-family: 'GmarketSansMedium', sans-serif;
            background-color: #495057;
            color: #f8f9fa;
            font-weight: bold;
            font-size: 1.1em;
        }

        .time-slot-box.am th {
            background-color: #0097e6; /* 오전: 밝은 파란색 */
            color: #212529; /* 가독성을 위해 어두운 글자색으로 변경 */
        }

        .time-slot-box.pm th {
            background-color: #27ae60; /* 오후: 밝은 녹색 */
            color: #212529; /* 가독성을 위해 어두운 글자색으로 변경 */
        }

        .closed,
        .finished {
            color: #f26d6d; /* 조금 연한 붉은색으로 통일 */
            font-weight: bold;
        }
        .surgery,
        .congestion {
            color: #f0ad4e; /* 짙은 노란색으로 통일 */
            font-weight: bold;
        }
        .open {
            /* No visible text to style */
            font-weight: bold;
        }

        /* Highlighter effect for doctor's name */
        .highlight-text {
            padding: 0 0.4em; /* 수직 여백을 제거하여 박스 높이 조정 */
            border-radius: 4px;
            color: #18181b; /* Dark text for contrast on all highlights */
            position: relative; /* 오버레이 위에 표시되도록 z-index와 함께 사용 */
            z-index: 2; /* 오버레이(z-index: 1) 위에 위치하도록 설정 */
        }
        .highlight-closed,
        .highlight-finished {
            background-color: #f26d6d; /* 조금 연한 붉은색 배경 */
        }
        .highlight-surgery,
        .highlight-congestion {
            background-color: #f0ad4e; /* 짙은 노란색 배경 */
        }

        /* Grouping Styles */
        .group-start td, .group-middle td, .group-end td {
            background-color: #3c424a; /* 그룹화된 행의 배경색 */
        }

        .group-start td {
            border-top: 2px solid #6c757d;
        }
        .group-end td {
            border-bottom: 2px solid #6c757d;
        }

        /* Overlay effect for inactive rows */
        .row-inactive td {
            position: relative; /* 오버레이의 위치 기준점 설정 */
        }

        .row-inactive td::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(52, 58, 64, 0.65); /* 반투명 회색 배경 */
            background-image: repeating-linear-gradient( /* 사선 패턴 */
                -45deg,
                transparent, transparent 15px,
                rgba(0, 0, 0, 0.1) 15px, rgba(0, 0, 0, 0.1) 30px
            );
            z-index: 1; /* 텍스트 위에 오버레이가 위치하도록 설정 */
        }

        /* LED Indicator Styles */
        .led-indicator {
            display: inline-block;
            width: 1.8vh;
            height: 1.8vh;
            border-radius: 25%; /* 모서리가 둥근 사각형 모양으로 변경 */
            margin-right: 0.6em;
            vertical-align: middle;
            border: 1px solid rgba(0, 0, 0, 0.3);
        }

        /*
        .dept-icon {
            margin-right: 0.4em;
            vertical-align: middle;
        }
        */

        .led-surg { /* 외과: 파랑 */
            background-color: #3498db;
            box-shadow: 0 0 8px #3498db;
            animation: pulse-animation 1.8s infinite ease-in-out;
        }
        .led-im { /* 내과: 주황 */
            background-color: #f39c12;
            box-shadow: 0 0 8px #f39c12;
            animation: pulse-animation 1.8s infinite ease-in-out;
        }
        .led-thyroid { /* 갑상선유방센터: 빨강 */
            background-color: #e74c3c;
            box-shadow: 0 0 8px #e74c3c;
            animation: pulse-animation 1.8s infinite ease-in-out;
        }
        .led-ns { /* 신경외과: 보라 */
            background-color: #9b59b6;
            box-shadow: 0 0 8px #9b59b6;
            animation: pulse-animation 1.8s infinite ease-in-out;
        }
        .led-os { /* 정형외과: 녹색 */
            background-color: #2ecc71;
            box-shadow: 0 0 8px #2ecc71;
            animation: pulse-animation 1.8s infinite ease-in-out;
        }
        .led-obgy { /* 산부인과: 분홍 */
            background-color: #e84393;
            box-shadow: 0 0 8px #e84393;
            animation: pulse-animation 1.8s infinite ease-in-out;
        }
        .led-off { /* 꺼진 상태: 회색 */
            background-color: #495057;
            box-shadow: inset 0 0 4px rgba(0,0,0,0.4);
        }
        @keyframes pulse-animation {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }

        .circular-timer {
            width: 4vh;
            height: 4vh;
        }
        .circular-chart {
            display: block;
            max-width: 100%;
            max-height: 100%;
        }
        .circular-chart .circle-bg {
            fill: none;
            stroke: #4a5c6d;
            stroke-width: 3.8;
        }
        .circular-chart .circle {
            fill: none;
            stroke: #a3c4ff;
            stroke-width: 2.8;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 1s linear;
        }

        .version-info {
            position: fixed;
            right: 5px;
            bottom: 5px;
            font-size: 0.3em;
            color: #6c757d;
            user-select: none;
        }
    </style>
</head>
<body>
    <div class="title-box">
        <div class="title-group">
            <img id="logo" src="kooh_logo.png" alt="병원 로고" onerror="this.src='/kooh_logo.png'; this.onerror=function(){this.style.display='none'};">
            <h1 class="main-title">구병원 진료 스케줄</h1>
            <p class="current-date"></p>
        </div>
        <div id="refresh-timer" class="circular-timer">
            <svg viewBox="0 0 36 36" class="circular-chart">
                <path class="circle-bg"
                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                />
                <path class="circle"
                    stroke-dasharray="100, 100"
                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                />
            </svg>
        </div>
    </div>
    
    <div class="schedule-container">
        <!-- 오전 진료 -->
        <div class="time-slot-box am">
            <div class="finished-overlay">
                <span>오전 진료 마감</span>
            </div>
            <h2 class="schedule-section-title">오전 진료</h2>
            <table>
                <thead>
                    <tr>
                        <th>진료과</th>
                        <th>진료의사</th>
                        <th>비고</th>
                    </tr>
                </thead>
                <tbody id="am-schedule-body"></tbody>
            </table>
        </div>

        <!-- 오후 진료 -->
        <div class="time-slot-box pm">
            <h2 class="schedule-section-title">오후 진료</h2>
            <table>
                <thead>
                    <tr>
                        <th>진료과</th>
                        <th>진료의사</th>
                        <th>비고</th>
                    </tr>
                </thead>
                <tbody id="pm-schedule-body"></tbody>
            </table>
        </div>
    </div>

    <p class="version-info">v.20250813-010</p>

    <script>
        const sheetId = '1m0kCyq3QI9e203Rkhh0_gTFD6Jdafn89p3-AbddZ2OU';
        const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
        const REFRESH_INTERVAL = 30000; // 30초

        const gidMap = {
            '일': '1340551526',
            '월': '166831320',
            '화': '1050890560',
            '수': '675567842',
            '목': '1074220298',
            '금': '1055010041',
            '토': '944320917',
        };

        /*
        const departmentIcons = {
            '외과': '⚕️',
            '내과': '🩺',
            '갑상선유방센터': '🎀',
            '신경외과': '🧠',
            '정형외과': '🦾',
            '산부인과': '🤰'
        };
        */

        const getDepartment = (row, index) => {
            if (!row || !row.c[index]) return '';
            let department = row.c[index].v;
            if (department.includes(':')) {
                department = department.split(':')[1].trim();
            }
            return department;
        };

        function restartCircularTimerAnimation(circleElement, interval) {
            if (!circleElement) return;
            // 애니메이션 리셋
            circleElement.style.transition = 'none';
            circleElement.style.strokeDashoffset = '100';
            // 애니메이션 시작 (setTimeout으로 브라우저가 리셋을 인지할 시간을 줌)
            setTimeout(() => {
                circleElement.style.transition = `stroke-dashoffset ${interval / 1000}s linear`;
                circleElement.style.strokeDashoffset = '0';
            }, 50);
        }

        function checkAmSessionStatus() {
            const now = new Date();
            const amOverlay = document.querySelector('.time-slot-box.am .finished-overlay');
            
            // --- 오전 진료 마감 시간 설정 ---
            // 아래 조건문에서 마감 시간을 변경할 수 있습니다.
            // 현재는 12시 30분으로 설정되어 있습니다.
            // 예: 10시 30분으로 테스트하려면 (now.getHours() > 10 || (now.getHours() === 10 && now.getMinutes() >= 30))
            if (now.getHours() > 12 || (now.getHours() === 12 && now.getMinutes() >= 30)) { 
                amOverlay.style.display = 'flex';
            } else {
                amOverlay.style.display = 'none';
            }
        }

        function fetchSchedule() {
            const refreshTimerCircle = document.querySelector('#refresh-timer .circle');
            restartCircularTimerAnimation(refreshTimerCircle, REFRESH_INTERVAL);

            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth() + 1;
            const day = today.getDate();
            const dayOfWeek = dayNames[today.getDay()];
            const dateContainer = document.querySelector('.current-date');
            dateContainer.textContent = `(${year}년 ${month}월 ${day}일 ${dayOfWeek}요일)`;

            checkAmSessionStatus(); // 시간 확인하여 오버레이 표시

            const currentDayName = dayNames[today.getDay()];
            const currentGid = gidMap[currentDayName];
            
            if (!currentGid) {
                console.error(`Error: Gid for ${currentDayName} not found.`);
                return;
            }

            const apiUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?gid=${currentGid}&tqx=out:json`;
            
            fetch(apiUrl)
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    return res.text();
                })
                .then(text => {
                    // Google's JSONP-like response needs to be cleaned up
                    const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]+)\)/);
                    if (!match || !match[1]) {
                        throw new Error('Google Sheet 응답 형식을 파싱할 수 없습니다.');
                    }
                    const jsonText = match[1];
                    const json = JSON.parse(jsonText);

                    const table = json.table;
                    const rawRows = table.rows;

                    const headers = rawRows[0].c.map(header => (header ? header.v : ''));

                    const ampmIndex = headers.indexOf('오전/오후');
                    const departmentIndex = headers.indexOf('진료과');
                    const doctorIndex = headers.indexOf('진료의사');
                    const statusIndex = headers.indexOf('비고');

                    if ([ampmIndex, departmentIndex, doctorIndex, statusIndex].includes(-1)) {
                        console.error('Error: Required column headers not found.');
                        return;
                    }

                    const amRows = [];
                    const pmRows = [];

                    for (let i = 1; i < rawRows.length; i++) {
                        const row = rawRows[i];
                        const ampm = row.c[ampmIndex] ? row.c[ampmIndex].v : '';
                        if (ampm === '오전') {
                            amRows.push(row);
                        } else if (ampm === '오후') {
                            pmRows.push(row);
                        }
                    }

                    const renderGroupedRows = (tbody, dataRows) => {
                        tbody.innerHTML = '';
                        for (let i = 0; i < dataRows.length; i++) {
                            const currentRow = dataRows[i];
                            const prevRow = dataRows[i - 1];
                            const nextRow = dataRows[i + 1];

                            const currentDept = getDepartment(currentRow, departmentIndex);
                            const prevDept = getDepartment(prevRow, departmentIndex);
                            const nextDept = getDepartment(nextRow, departmentIndex);

                            let groupClass = '';
                            if (currentDept !== prevDept) {
                                groupClass += 'group-start ';
                            }
                            if (currentDept !== nextDept) {
                                groupClass += 'group-end ';
                            }
                            if (currentDept === prevDept && currentDept === nextDept) {
                                groupClass += 'group-middle ';
                            }

                            const doctor = currentRow.c[doctorIndex] ? currentRow.c[doctorIndex].v : '';
                            const status = currentRow.c[statusIndex] ? currentRow.c[statusIndex].v : '';

                            const ledColorMap = {
                                '외과': 'led-surg',
                                '내과': 'led-im',
                                '갑상선유방센터': 'led-thyroid',
                                '신경외과': 'led-ns',
                                '정형외과': 'led-os',
                                '산부인과': 'led-obgy'
                            };
                            const isInactive = status === '휴진' || status === '마감';
                            const ledColorClass = ledColorMap[currentDept] || 'led-off';
                            const ledClass = isInactive ? 'led-off' : ledColorClass;
                            const ledIndicator = `<span class="led-indicator ${ledClass}"></span>`;
                            // const icon = departmentIcons[currentDept] ? `<span class="dept-icon">${departmentIcons[currentDept]}</span>` : '';

                            let statusClass = '';
                            if (status === '휴진') statusClass = 'closed';
                            else if (status === '수술중') statusClass = 'surgery';
                            else if (status === '마감') statusClass = 'finished';
                            else if (status === '대기혼잡') statusClass = 'congestion';
                            else if (status === 'O') statusClass = 'open';
                            
                            const cellContent = status === 'O' ? '' : status;
                            let statusCellContent = cellContent;
                            if (statusClass && statusClass !== 'open') {
                                const highlightColorClass = `highlight-${statusClass}`;
                                statusCellContent = `<span class="highlight-text ${highlightColorClass}">${cellContent}</span>`;
                            }

                            const tr = document.createElement('tr');
                            tr.className = groupClass.trim();

                            if (isInactive) {
                                tr.classList.add('row-inactive');
                            }
                            
                            tr.innerHTML = `
                                <td>${ledIndicator}${currentDept}</td>
                                <td>${doctor}</td>
                                <td class="${statusClass}">${statusCellContent}</td>
                            `;
                            tbody.appendChild(tr);
                        }
                    };

                    const amScheduleBody = document.querySelector('#am-schedule-body');
                    const pmScheduleBody = document.querySelector('#pm-schedule-body');
                    renderGroupedRows(amScheduleBody, amRows);
                    renderGroupedRows(pmScheduleBody, pmRows);
                })
                .catch(e => {
                    console.error('Fetch error:', e);
                    const amScheduleBody = document.querySelector('#am-schedule-body');
                    const pmScheduleBody = document.querySelector('#pm-schedule-body');
                    const errorMessage = `데이터를 불러오는 데 실패했습니다. 네트워크 또는 구글 시트 설정을 확인해주세요. (오류: ${e.message})`;
                    amScheduleBody.innerHTML = `<tr><td colspan="3" style="color: red; white-space: normal;">${errorMessage}</td></tr>`;
                    pmScheduleBody.innerHTML = '';
                });
        }

        setInterval(fetchSchedule, REFRESH_INTERVAL);
        fetchSchedule();
    </script>
</body>
</html>
