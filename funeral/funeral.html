<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>구병원 장례식장</title>
    <style>
        @font-face {
            font-family: 'S-CoreDream';
            src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/S-CoreDream-5Medium.woff') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        body {
            font-family: 'S-CoreDream', 'Malgun Gothic', '맑은 고딕', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background-color: #dee2e6;
            min-height: 100vh;
            overflow: hidden;
        }
        
        .container {
            width: 100%;
            height: 100vh;
            display: grid;
            /* 제목 박스 높이를 줄이고, 메인 콘텐츠 영역을 늘림 */
            grid-template-rows: 12% 78% 10%; 
            grid-template-columns: 1fr;
            padding: 1vh;
            box-sizing: border-box;
            gap: 1vh;
        }

        .title-box {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between; /* 양쪽 정렬로 변경 */
            padding: 0 3vh; /* 좌우 여백 */
        }

        .title-group {
            display: flex;
            align-items: center;
        }

        .room-number-box {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 10vh;
            height: 10vh;
            background-color: #FFD700; /* 노란색으로 변경 */
            border-radius: 10px;
            margin-right: 2vh;
        }
        
        .room-number {
            font-size: 6vh;
            font-weight: bold;
            color: #2c3e50; /* 텍스트 색상을 어둡게 */
        }

        .room-title {
            font-size: 8vh; /* 분향실 글자 크기 더 키움 */
            font-weight: bold;
            color: #2c3e50;
        }

        .main-content {
            display: grid;
            /* 헤더 높이를 줄이고, 데이터 영역을 늘림 */
            grid-template-rows: 12% 88%;
            grid-template-columns: 1fr;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header-row {
            display: grid;
            /* 고인명 칸을 30%로 줄이고 상주 칸을 70%로 넓힘 */
            grid-template-columns: 30% 70%;
            border-bottom: 2px solid #e0e0e0;
        }

        .header-cell {
            background-color: #2c3e50;
            color: #ffffff;
            font-size: 4.5vh; /* 제목 글자 크기 증가 */
            text-align: center;
            padding: 0.5vh; /* 제목 박스 상하 여백 축소 */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .header-cell:nth-child(1) {
            border-right: 2px solid #ffffff;
        }

        .data-row {
            display: grid;
            /* 고인명 칸을 30%로 줄이고 상주 칸을 70%로 넓힘 */
            grid-template-columns: 30% 70%;
            text-align: center;
        }
        
        .data-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1vh;
            word-break: break-all;
            white-space: pre-wrap;
            border-right: 2px solid #e0e0e0;
        }

        .data-cell:last-child {
            border-right: none;
        }

        /* 고인명 글자 크기 더 크게 조정 */
        #deceased-name {
            font-size: 10vh;
        }

        /* 상주 글자 크기 더 크게 조정 */
        #mourner-name {
            font-size: 6vh; 
            text-align: left; 
            justify-content: flex-start;
            padding: 1.5vh 1vh 1.5vh 3vh; /* 상하 여백 추가 */
        }

        /* 하단 박스를 가로로 정렬하기 위한 컨테이너 */
        .footer-container {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2개의 열로 나란히 배치 */
            gap: 1vh; /* 두 박스 사이의 간격 */
        }
        
        .info-box {
            display: grid;
            grid-template-columns: 35% 65%;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* 발인/장지 라벨 글자 크기 더 크게 조정 */
        .info-header {
            background-color: #2c3e50;
            color: #ffffff;
            font-size: 5vh; 
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            border-top-left-radius: 10px;
            border-bottom-left-radius: 10px;
            padding: 1vh;
        }

        /* 발인/장지 데이터 글자 크기 더 크게 조정 */
        .info-data {
            color: #2c3e50;
            font-size: 5vh; 
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            word-break: break-all;
            white-space: pre-wrap;
            padding: 1vh;
        }

        .circular-timer {
            width: 6vh;
            height: 6vh;
        }
        .circular-chart {
            display: block;
            max-width: 100%;
            max-height: 100%;
        }
        .circular-chart .circle-bg {
            fill: none;
            stroke: #e9ecef;
            stroke-width: 3.8;
        }
        .circular-chart .circle {
            fill: none;
            stroke: #495057;
            stroke-width: 2.8;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 1s linear;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="title-box">
            <div class="title-group">
                <div class="room-number-box">
                    <span class="room-number" id="room-number"></span>
                </div>
                <span class="room-title">분향실</span>
            </div>
            <div id="refresh-timer" class="circular-timer">
                <svg viewBox="0 0 36 36" class="circular-chart">
                    <path class="circle-bg"
                        d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                    />
                    <path class="circle"
                        stroke-dasharray="100, 100"
                        d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                    />
                </svg>
            </div>
        </div>

        <div class="main-content">
            <div class="header-row">
                <div class="header-cell">고인명</div>
                <div class="header-cell">상주</div>
            </div>
            <div class="data-row">
                <div class="data-cell" id="deceased-name"></div>
                <div class="data-cell" id="mourner-name"></div>
            </div>
        </div>
        
        <div class="footer-container">
            <div class="info-box">
                <div class="info-header">발인</div>
                <div class="info-data" id="funeral-date"></div>
            </div>

            <div class="info-box">
                <div class="info-header">장지</div>
                <div class="info-data" id="burial-place"></div>
            </div>
        </div>
    </div>

    <script>
        // 구글 시트의 ID를 정확하게 입력해주세요.
        const SPREADSHEET_ID = '19O4dLcRh-WXT0hWWFoLhQYhnpReAr0htIShNEUjEEDg';
        // gid=0은 첫 번째 시트 탭을 의미합니다. 다른 탭을 사용한다면 gid 값을 변경하세요.
        const GID = 0;
        const REFRESH_INTERVAL = 30000; // 30초

        function restartCircularTimerAnimation(circleElement, interval) {
            if (!circleElement) return;
            circleElement.style.transition = 'none';
            circleElement.style.strokeDashoffset = '100';
            setTimeout(() => {
                circleElement.style.transition = `stroke-dashoffset ${interval / 1000}s linear`;
                circleElement.style.strokeDashoffset = '0';
            }, 50);
        }

        function fetchData() {
            const sheetUrl = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?gid=${GID}&tqx=out:json`;
            const container = document.querySelector('.container');
            const refreshTimerCircle = document.querySelector('#refresh-timer .circle');
            restartCircularTimerAnimation(refreshTimerCircle, REFRESH_INTERVAL);

            fetch(sheetUrl)
                .then(response => response.text())
                .then(text => {
                    const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
                    const jsonData = JSON.parse(jsonText);
                    
                    const headers = jsonData.table.cols.map(col => col.label);
                    const rows = jsonData.table.rows;
                    
                    const dataRows = [];
                    rows.forEach(row => {
                        const item = {};
                        row.c.forEach((cell, i) => {
                            const header = headers[i];
                            if (header) {
                                // 셀의 'f' (formatted value) 속성을 사용하여 정확한 값을 가져옴
                                item[header] = cell ? (cell.f || cell.v || '') : '';
                            }
                        });
                        const room = item.분향실 ? String(item.분향실).trim() : '';
                        if (room === roomNumber) {
                            dataRows.push(item);
                        }
                    });

                    // 데이터 유무에 따라 화면 표시/숨김 처리
                    if (dataRows.length > 0) {
                        container.style.display = 'grid';
                        const item = dataRows[0];
                        const deceasedName = item.고인명 || '';

                        document.getElementById('room-number').textContent = item.분향실 || roomNumber;
                        document.getElementById('deceased-name').textContent = deceasedName.trim() ? `故 ${deceasedName}` : '';
                        document.getElementById('mourner-name').textContent = item.상주 || '';
                        document.getElementById('funeral-date').textContent = item.발인 || '';
                        document.getElementById('burial-place').textContent = item.장지 || '';
                    } else {
                        container.style.display = 'none'; // 데이터가 없으면 화면 전체를 숨김
                    }
                })
                .catch(error => {
                    console.error('데이터를 불러오는 중 오류가 발생했습니다:', error);
                    container.style.display = 'grid';
                    document.getElementById('room-number').textContent = roomNumber;
                    document.getElementById('deceased-name').textContent = '데이터 로딩 오류';
                    document.getElementById('mourner-name').textContent = '데이터 로딩 오류';
                    document.getElementById('funeral-date').textContent = '데이터 로딩 오류';
                    document.getElementById('burial-place').textContent = '데이터 로딩 오류';
                });
        }
        
        const urlParams = new URLSearchParams(window.location.search);
        const roomNumber = urlParams.get('room');

        if (!roomNumber) {
            // URL에 room 파라미터가 없으면 room=1로 리디렉션
            window.location.replace(`${window.location.pathname}?room=1`);
        } else {
            fetchData();
            setInterval(fetchData, REFRESH_INTERVAL);
        }
    </script>
</body>
</html>
